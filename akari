#!/usr/bin/env node
(e=>{const t={};!function r(n){return n in t||(t[n]={},e[n](t[n],r)),t[n]}(".")})({".":(e,t)=>{const r=require("readline"),n=t("tools/admin"),s=t("targets/self"),o=t("targets/server"),i=t("targets/client");function a(e){e.then((e=>process.exit(e?0:1)))}function c(e){"self"==e?(0,s.build)():"ui"==e?(0,i.build)(!1):"core"==e?(0,o.build)(!1):"both"==e?((0,i.build)(!1,"c"),(0,o.build)(!1,"s")):"watch ui"==e?(0,i.build)(!0):"watch core"==e?(0,o.build)(!0):"watch both"==e?((0,i.build)(!0,"c"),(0,o.build)(!0,"s")):/^reload-static [\w\\\.]+$/.test(e)?a(n.admin.core({type:"content",sub:{type:"reload-static",key:e.slice(14)}})):"disable-source-map"==e?a(n.admin.core({type:"content",sub:{type:"disable-source-map"}})):"enable-source-map"==e?a(n.admin.core({type:"content",sub:{type:"enable-source-map"}})):"config"==e?(0,o.uploadConfig)():(console.log("unknown command"),process.exit(1))}process.on("unhandledRejection",(e=>{console.log("unhandled reject: ",e),process.exit(0)}));const l=[process.argv[2],process.argv[3]].filter((e=>e)).join(" ");(0,s.hashself)().then((e=>{if(l.startsWith("self")||"2f1bcab8bfd6fd5688127c73d68054a7"==e)c(l);else{r.createInterface({input:process.stdin,output:process.stdout}).question("script source code may be changed after last bootstrap, continue? (y|n): ",(e=>{"y"!=e&&"Y"!=e?process.exit(2):c(l)}))}}))},"tools/admin":(e,t)=>{const r=require("crypto"),n=require("fs"),s=require("https"),o=require("chalk"),i=t("common"),a=t("config"),c=t("tools/ssh");let l=null;async function p(){if(!l){const e=await(0,c.download)("akariv",!0);if(!e)return(0,i.logCritical)("adm","cannot connect akari (server) (1)");const t=e[0].data.toString();if(l=t.split(":").map((e=>parseInt(e))),3!=l.length||l.some((e=>!e)))return(0,i.logCritical)("adm","cannot connect akari (server) (2)")}return l}const u=n.readFileSync(a.config.codebook,"utf-8"),m=(e,t)=>new Promise((n=>{const c=`adm${t??""}`,l=JSON.stringify(e);p().then((t=>{const p=r.scryptSync(u.slice(t[1],32),u.slice(t[2],32),32),m=r.randomFillSync(new Uint8Array(16)),d=r.createCipheriv("aes-256-cbc",p,m),f=[];d.on("data",(e=>f.push(Buffer.from(e)))),d.write(l),d.end();const h=Buffer.concat(f).toString("hex"),y=Buffer.from(m).toString("hex")+h,g=s.request({host:a.config.domain,method:"POST",port:t[0]});g.on("error",(e=>{"ECONNREFUSED"==e.code?(0,i.logError)(c,"cannot connect akari (server)"):(0,i.logError)(c,`request error ${e.message}`,e),n(!1)})),g.on("socket",(e=>{e.on("error",(()=>{n(!1)})),g.write(y),g.end()})),g.on("response",(t=>{if(200!=t.statusCode)(0,i.logError)(c,`response ${t.statusCode}`),n(!1);else if("service"==e.target)t.pipe(process.stdout),t.on("end",(()=>n(!0)));else if("self-host"==e.target){if("stop"==e.data)t.on("data",(()=>{})),t.on("end",(()=>{(0,i.logInfo)(c,o`ack stop watch core`),n(!0)}));else if("start"==e.data){let e=!1,r=Buffer.alloc(0);t.on("data",(s=>{if(!e){if(r=Buffer.concat([r,Buffer.from(s)]),r.length<4)return;{e=!0;const s=r.slice(0,4).toString();"that"==s?((0,i.logInfo)(c,o`ack {yellow restart watch core}`),n(!0)):"this"==s?(process.stdout.write(r.slice(4)),t.pipe(process.stdout)):((0,i.logError)(c,`start watch core received unexpected header ${s}`),n(!1))}}})),t.on("end",(()=>n(!0)))}}else{let r="";t.on("data",(e=>{r+=e})),t.on("end",(()=>{r=="ACK "+l?((0,i.logInfo)(c,o`{cyan ACK} {yellow ${(0,i.formatAdminPayload)(e)}}`),n(!0)):((0,i.logError)(c,"unexpected response "+r),n(!1))}))}}))}))}));e.admin=new class{get port(){return p().then((e=>e[0]))}core(e,t){return m({target:"core",data:e},t)}devpage(e,t){return m({target:"dev-page",data:e},t)}selfhost(e,t){return m({target:"self-host",data:e},t)}service(e,t){return m({target:"service",data:e},t)}}},"targets/self":(e,t)=>{const r=require("crypto"),n=require("fs"),s=require("path"),o=require("chalk"),i=t("common"),a=t("tools/eslint"),c=t("tools/typescript"),l=t("tools/mypack"),p={base:"normal",entry:"script/index.ts",sourceMap:"no",watch:!1,configSubstitution:!1};async function u(e,t){for(const r of await n.promises.readdir(t,{withFileTypes:!0})){const o=s.join(t,r.name);if(r.isDirectory())await u(e,o);else if(r.isFile())e.push(o);else if(r.isSymbolicLink()){const t=await n.promises.readlink(o),r=await n.promises.lstat(t);r.isDirectory()?await u(e,t):r.isFile()&&e.push(t)}}}async function m(){const e=[];await u(e,"script"),e.sort();const t=r.createHash("md5");for(const s of e)await new Promise((e=>{const o=r.createHash("md5"),i=n.createReadStream(s);i.on("data",(e=>o.update(e))),i.on("end",(()=>{t.update(o.digest()),e()}))}));return t.digest("hex")}e.hashself=m,e.build=async function(){(0,i.logInfo)("akr",o`{cyan self}`),await(0,a.eslint)("self","node","script/**/*.ts");const e=(0,c.typescript)(p).check();if(!e.success)return(0,i.logCritical)("akr",o`{cyan self} failed at transpile`);const t=await(0,l.mypack)((r=e.files,{type:"app",entry:"/vbuild/index.js",files:r,minify:!0,shebang:!0,cleanupFiles:!1})).run();var r;if(!t.success)return(0,i.logCritical)("akr",o`{cyan self} failed at pack`);const s=t.resultJs.toString("utf-8").replaceAll("selfhash",await m());await n.promises.writeFile("akari",s),(0,i.logInfo)("akr",o`{cyan self} completed successfully`)}},"targets/server":(e,t)=>{const r=require("fs"),n=require("chalk"),s=t("config"),o=t("common"),i=t("tools/eslint"),a=t("tools/codegen"),c=t("tools/ssh"),l=t("tools/typescript"),p=t("tools/mypack"),u=e=>({base:"normal",entry:"src/core/index.ts",sourceMap:"normal",watch:e}),m=e=>({type:"app",entry:"/vbuild/core/index.js",files:e,sourceMap:!0,output:"index.js",printModules:!0,minify:!0}),d=e=>[{remote:"index.js",data:e.resultJs},{remote:"index.js.map",data:e.resultMap}];async function f(){(0,o.logInfo)("akr",n`{cyan server}`),await(0,i.eslint)("server","node",["src/core/*.ts"]);if(!(await(0,a.codegen)("server").generate()).success)return(0,o.logCritical)("akr",n`{cyan server} failed at code generation`);const e=(0,l.typescript)(u(!1)).check();if(!e.success)return(0,o.logCritical)("akr",n`{cyan server} failed at check`);const t=await(0,p.mypack)(m(e.files)).run();if(!t.success)return(0,o.logCritical)("akr",n`{cyan server} failed at pack`);if(!await(0,c.upload)(d(t),{basedir:s.config.approot}))return(0,o.logCritical)("akr",n`{cyan server} failed at upload`);(0,o.logInfo)("akr",n`{cyan server} complete successfully`)}function h(e){(0,o.logInfo)(`akr${e??""}`,n`watch {cyan server}`),(0,a.codegen)("server",e).watch();const t=(0,p.mypack)(m([]),e);(0,l.typescript)(u(!0),e).watch((async({files:r})=>{t.updateFiles(r);const n=await t.run();n.success&&n.hasChange&&await(0,c.upload)(d(n),{basedir:s.config.approot,additionalHeader:e})}))}e.uploadConfig=async function(){await(0,c.upload)({remote:"config",data:await r.promises.readFile("src/core/config.json")},{basedir:s.config.approot})},e.build=function(e,t){(e?h:f)(t)}},"targets/client":(e,t)=>{const r=require("fs"),n=require("path"),s=require("zlib"),o=require("chalk"),i=require("dayjs"),a=require("filesize"),c=require("memfs"),l=require("terser-webpack-plugin"),p=require("unionfs"),u=require("webpack"),m=t("common"),d=t("config"),f=t("tools/admin"),h=t("tools/eslint"),y=t("tools/codegen"),g=t("tools/ssh"),w=t("tools/sass"),$=t("tools/typescript"),b=e=>({base:"jsx-app",entry:"src/ui/index.tsx",sourceMap:"normal",watch:e}),v=e=>Object.entries(e.assets).map((e=>({remote:`static/${d.config.appname}/${e[0]}`,data:e[1].data}))),x="AKARIN_APP_CLIENT_OSIZE",k=x in process.env?"0"===process.env[x]?0:parseInt(process.env[x])||2:2;function S(e,t,i){(0,m.logInfo)(`wpk${i}`,o`${t?"watch":"once"} {yellow src/ui/index.js}`);const a=u({mode:"development",entry:{index:n.resolve("src","ui","index.js")},module:{rules:[{test:/\.js$/,exclude:/node_modules/,enforce:"pre",use:["source-map-loader"]}]},resolve:{symlinks:!1},output:{filename:"index.js",path:"/vbuild",pathinfo:!1},devtool:!1,cache:{type:"filesystem",name:`webpack-akari-${d.config.appname}`,cacheDirectory:n.resolve(".cache")},performance:{hints:!1},optimization:{moduleIds:"deterministic",chunkIds:"deterministic",mangleExports:"deterministic",innerGraph:!0,usedExports:!0,emitOnErrors:!1,flagIncludedChunks:!0,concatenateModules:!0,nodeEnv:"production",splitChunks:{hidePathInfo:!0,cacheGroups:{1:{test:/node_modules\/react-dom/,priority:20,chunks:"all",filename:"client-vendor1.js"},2:{test:/node_modules\/(rc|@ant-design)/,priority:20,chunks:"all",filename:"client-vendor2.js"},3:{test:/node_modules\/(antd|lodash)/,priority:20,chunks:"all",filename:"client-vendor3.js"},4:{test:/node_modules/,priority:10,chunks:"all",filename:"client-vendor4.js"}}},minimize:0!=k,minimizer:[new l({terserOptions:{format:{comments:!1},compress:2==k},extractComments:!1})]},plugins:[new u.SourceMapDevToolPlugin({exclude:/vendor/,filename:"[name].js.map"})]}),f={assets:{}};return a.inputFileSystem=(new p.Union).use(r).use(e),a.outputFileSystem=c.createFsFromVolume(new c.Volume),a.hooks.emit.tap("CompressSizePlugin",(e=>{for(const t of e.getAssets())f.assets[t.name]={data:Buffer.from(t.source.buffer()),compressSize:s.brotliCompressSync(t.source.buffer()).length}})),[a,f]}function C(e,t,n){n=n??"";const s=`/tmp/akari-stats-${i().format("YYYYMMDD-HHmmss")}.txt`,c=e=>t.assets[e]?.compressSize??0,l=a(e.assets.reduce(((e,t)=>e+t.size),0)),p=a(e.assets.reduce(((e,t)=>e+c(t.name)),0)||0),u=e.assets.filter((e=>e.name.includes("vendor"))).reduce(((e,t)=>Math.max(e,c(t.name))),0);if(0==e.errorsCount){if((0,m.logInfo)(`wpk${n}`,o`completed with {yellow ${e.assets.length}} assets in ${e.time/1e3}s, `+o`{yellow ${p}} ({${u>3e5?"red":"white"} max ${a(u||0)}})`),e.warningsCount>0){(0,m.logInfo)(`wpk${n}`,o`{yellow ${e.warningsCount}} warnings`);for(const{message:t}of e.warnings)console.log("  "+t)}}else{(0,m.logError)(`wpk${n}`,o`completed with {red ${e.errorsCount}} errors, stat file {yellow ${s}}`);for(const{message:t}of e.errors)(0,m.logError)(`wpk${n}`,t)}let d="";const f=["entry","rendered","initial","recorded"],h=["built","codeGenerated","cached","cacheable","optional","prefetched"];if(d+=`hash ${e.hash} time ${e.time}ms total size ${l} (${p})\n`,e.warningsCount){d+=`${e.warningsCount} warnings:\n`;for(const t of e.warnings)d+=JSON.stringify(t,void 0,1)+"\n"}if(e.errorsCount){d+=`${e.errorsCount} errors:\n`;for(const t of e.errors)d+=JSON.stringify(t,void 0,1)+"\n"}for(const t of e.assets)d+=`asset ${t.name} size ${a(t.size)} compress ${a(c(t.name))} chunks [${t.chunks.join(",")}] chunkNames [${t.chunkNames.join(",")}]\n`;for(const t of e.chunks){d+=`chunk ${t.id} files [${t.files.join(",")}] size ${a(t.size)} flags [${f.filter((e=>t[e])).join(",")}] ${t.modules.length} chunks\n`;for(const e of t.modules)if(d+=`  module ${e.id} size ${a(e.size)} flags [${h.filter((t=>e[t])).join(",")}] name "${e.name}" identifier "${e.identifier}"\n`,/\+ \d+ modules/.test(e.name)&&e.modules)for(const t of e.modules)d+=`    submodule ${t.name} size ${a(t.size)}\n`}r.writeFileSync(s,d)}async function I(e,t,n){const s="src/ui/index.html";t||(0,m.logInfo)(`htm${n??""}`,o`read {yellow ${s}}`);const i=e[0].map((e=>"/"+e)).concat(t?[`https://${d.config.domain}:${await f.admin.port}/client-dev.js`]:[]),a=(await r.promises.readFile(s,"utf-8")).replace("<script-placeholder />",i.map((e=>`<script type="text/javascript" src="${e}"><\/script>`)).join("\n  ")).replace("<stylesheet-placeholder />",e[1].map((e=>`<link rel="stylesheet" type="text/css" href="/${e}">`)).join("\n  "));return(0,m.logInfo)(`htm${n??""}`,"template rendered"),{remote:`static/${d.config.appname}/index.html`,data:Buffer.from(a)}}async function E(){(0,m.logInfo)("akr",o`{cyan client}`),await(0,h.eslint)("client","browser",["src/ui/**/*.ts","src/ui/**/*.tsx"]);const e=(async()=>{const e=(0,y.codegen)("client");if(!(await e.generate()).success)return(0,m.logCritical)("akr",o`{cyan client} failed at codegen`);const t=(0,$.typescript)(b(!1)).check();if(!t.success)return(0,m.logCritical)("akr",o`{cyan client} failed at check`);const r=c.Volume.fromJSON(t.files.reduce(((e,t)=>(e[t.name]=t.content,e)),{})),[n,s]=S(r,!1,""),i=await new Promise((e=>n.run(((t,r)=>e({error:t,statsObject:r})))));if(i.error)return(0,m.logError)("wpk",JSON.stringify(i.error,void 0,1)),(0,m.logCritical)("akr",o`{yellow client} failed at pack (1)`);const a=i.statsObject.toJson();return C(a,s,""),a.errorsCount>0?(0,m.logCritical)("akr",o`{cyan client} failed at pack (2)`):(n.close((e=>{e&&(0,m.logError)("wpk","failed to close compiler",e)})),v(s))})(),t=(async()=>{const e=await(0,w.sass)({entry:"src/ui/index.sass"}).transpile();return e.success?[{remote:`static/${d.config.appname}/index.css`,data:e.resultCss}]:(0,m.logCritical)("akr",o`{cyan client} failed at transpile`)})(),s=await Promise.all([e,t]),i=await I([s[0].map((e=>n.basename(e.remote))).filter((e=>e.endsWith(".js"))),s[1].map((e=>n.basename(e.remote)))],!1);"AKARIN_OUTPUT_LOCAL"in process.env&&(await r.promises.mkdir("localdemo",{recursive:!0}),await Promise.all(s[0].map((e=>r.promises.writeFile(n.resolve("localdemo",e.remote.substring(d.config.appname.length+8)),e.data)))));if(!await(0,g.upload)(s[0].concat(s[1]).concat([i]),{filenames:!1}))return(0,m.logCritical)("akr",o`{cyan client} failed at upload`);if(!await f.admin.core({type:"content",sub:{type:"reload-static",key:d.config.appname}}))return(0,m.logCritical)("akr",o`{cyan client} failed at reload`);(0,m.logInfo)("akr",o`{cyan client} complete successfully`)}function T(e){e=e??"",(0,m.logInfo)(`akr${e}`,o`watch {cyan client}`);let[t,r]=[[],[]],s=!1;const i=(0,m.watchvar)((async()=>{const o=s;s=!1;const i=await I([t.map((e=>n.basename(e.remote))).filter((e=>e.endsWith(".js"))),r.map((e=>n.basename(e.remote)))],!0,e);t.length>0&&await(0,g.upload)(t.concat(r).concat([i]),{filenames:!1,additionalHeader:e})&&(await f.admin.core({type:"content",sub:{type:"reload-static",key:d.config.appname}},e),await f.admin.devpage(o?"reload-all":"reload-css",e))}));(0,y.codegen)("client",e).watch();const a=new c.Volume,[l,p]=S(a,!0,e);let u=[],h=null;(0,$.typescript)(b(!0),e).watch((async({files:r})=>{for(const{name:e,content:t}of r)a.existsSync(e)||e.endsWith(".map")||console.log(o`   + ${e}`),await a.promises.mkdir(n.dirname(e),{recursive:!0}),await a.promises.writeFile(e,t);u=r,l.running?(0,m.logError)(`wpk${e}`,"already repacking, discard"):((0,m.logInfo)(`wpk${e}`,"repack"),l.run(((r,c)=>{if(r)return void(0,m.logError)(`wpk${e}`,"webpack fatal error",r);const d=c.toJson();C(d,p,e),function(e,t,r){const s=[],i=n.resolve("src");for(const t of e.modules)if(/\+ \d+ modules/.test(t.name)&&t.modules)for(const e of t.modules){const t=n.resolve(e.name);t.startsWith(i)&&s.push(t)}else{const e=n.resolve(t.name);e.startsWith(i)&&s.push(e)}const a=t.filter((e=>!s.includes(e.name)&&!s.some((t=>t+".map"==e.name))));for(const e of a)t.splice(t.indexOf(e),1),r.unlinkSync(e.name),e.name.endsWith(".map")||console.log(o`   {gray - ${e.name}}`)}(d,u,a),0==d.errorsCount&&(d.hash!=h?(h=d.hash,t=v(p),s=!0,i()):(0,m.logInfo)(`wpk${e}`,o`completed with {gray no change}`),l.close((e=>{e&&(0,m.logError)("wpk","failed to close compiler",e)})))})))})),(0,w.sass)({entry:"src/ui/index.sass"},e).watch((e=>{r=[{remote:`static/${d.config.appname}/index.css`,data:e.resultCss}],i()}))}e.build=function(e,t){(e?T:E)(t)}},common:(e,t)=>{const r=require("chalk"),n=require("dayjs");function s(e){switch(e.type){case"ping":return"ping";case"shutdown":return"shutdown";case"content":switch(e.sub.type){case"reload-static":return`reload-static ${e.sub.key}`;case"reload-config":return"reload-config";case"enable-source-map":return"source-map enable";case"disable-source-map":return"source-map disable";default:return`unknown content command ${e}`}case"auth":switch(e.sub.type){case"enable-signup":return"enable-signup";case"disable-signup":return"disable-signup";case"activate-user":return`activate-user ${e.sub.userId}`;case"inactivate-user":return`inactivate-user ${e.sub.userId}`;case"remove-device":return`remove-device ${e.sub.deviceId}`;default:return`unknown auth command ${e}`}default:return`unknown core command ${JSON.stringify(e)}`}}e.logInfo=function(e,t,s){s?console.log(r`[{green ${n().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`,s):console.log(r`[{green ${n().format("HH:mm:ss.SSS")}} {gray ${e}}] ${t}`)},e.logError=function(e,t,s){s?console.log(r`[{green ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`,s):console.log(r`[{green ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`)},e.logCritical=function(e,t){return console.log(r`[{green ${n().format("HH:mm:ss.SSS")}} {red ${e}}] ${t}`),process.exit(1)},e.watchvar=function(e,t){let r=!1;return setInterval((()=>{r&&(r=!1,e())}),t?.interval??3001),t?.initialCall&&e(),()=>r=!0},e.formatAdminCoreCommand=s,e.formatAdminPayload=function(e){switch(e.target){case"core":return s(e.data);case"dev-page":switch(e.data){case"reload-all":return"dev-page reload-all";case"reload-css":return"dev-page reload-css";default:return`unknown dev-page command ${e}`}case"service":switch(e.data){case"start":return"systemctl start";case"status":return"systemctl status";case"stop":return"systemctl stop";case"restart":return"systemctl restart";case"is-active":return"systemctl is-active";default:return`unknown service payload ${e}`}case"self-host":switch(e.data){case"start":return"self-host start core";case"stop":return"self-host stop core";default:return`unknown self-host command ${e}`}default:return`unknown command ${JSON.stringify(e)}`}}},config:(e,t)=>{const r=require("fs");e.config=JSON.parse(r.readFileSync("akaric","utf-8"))},"tools/ssh":(e,t)=>{const r=require("fs"),n=require("path"),s=require("stream"),o=require("chalk"),i=require("ssh2-sftp-client"),a=t("config"),c=t("common"),l={host:a.config.domain,username:a.config.ssh.user,privateKey:r.readFileSync(a.config.ssh.identity),passphrase:a.config.ssh.passphrase};e.upload=async function(e,t){e=Array.isArray(e)?e:[e];const r=new i;for(const t of e)if(!t.data||!Buffer.isBuffer(t.data))return(0,c.logError)("ssh",`${n.basename(t.remote)} invalid data`),!1;try{await r.connect(l);for(const s of e)await r.put(s.data,n.join(t?.basedir??a.config.webroot,s.remote),{writeStreamOptions:{mode:s.mode||420}});return await r.end(),(0,c.logInfo)(`ssh${t?.additionalHeader??""}`,o`upload {yellow ${e.length}} files ${t?.filenames?"":e.map((e=>o.yellow(n.basename(e.remote))))}`),!0}catch(e){return(0,c.logError)(`ssh${t?.additionalHeader??""}`,"error "+e.message),!1}},e.download=async function(e,t){e=Array.isArray(e)?e:[e];const r=new i;try{await r.connect(l);const i=[];for(const t of e){const e=[];await r.get(n.join(a.config.webroot,t),new s.Writable({write(t,r,n){e.push(Buffer.from(t,r)),n()}})),i.push({remote:t,data:Buffer.concat(e)})}return await r.end(),t||(0,c.logInfo)("ssh",o`download {yellow ${i.length}} file`),i}catch(e){return(0,c.logError)("ssh","error "+e.message),null}}},"tools/eslint":(e,t)=>{const r=require("eslint"),n=t("common");e.eslint=async function(e,t,s){if(!("AKARIN_ESLINT"in process.env))return;const o=new r.ESLint({useEslintrc:!1,baseConfig:{parser:"@typescript-eslint/parser",parserOptions:{ecmaVersion:2020,sourceType:"module",ecmaFeatures:{jsx:"browser"==t}},plugins:"node"==t?["@typescript-eslint"]:["@typescript-eslint","react","react-hooks","jsx-a11y"],env:{node:"node"==t,browser:"browser"==t},extends:"node"==t?["eslint:recommended","plugin:@typescript-eslint/recommended"]:["eslint:recommended","plugin:@typescript-eslint/recommended","plugin:react/recommended","plugin:react-hooks/recommended","plugin:jsx-a11y/recommended"],settings:"node"==t?{}:{react:{version:"17.0"}},rules:"node"==t?{"array-callback-return":"warn","class-methods-use-this":"error","comma-dangle":"off","eol-last":"error","no-constant-condition":"off","no-multiple-empty-lines":"error","no-extra-parens":"off","no-lone-blocks":"warn","no-sequences":"error","no-template-curly-in-string":"warn","no-trailing-spaces":"error","no-unused-expressions":"off","prefer-named-capture-group":"off","require-await":"error",semi:"off","@typescript-eslint/comma-dangle":["warn","always-multiline"],"@typescript-eslint/consistent-type-imports":"off","@typescript-eslint/explicit-module-boundary-types":["warn",{allowArgumentsExplicitlyTypedAsAny:!0}],"@typescript-eslint/member-delimiter-style":["warn",{multiline:{delimiter:"comma",requireLast:!0},singleline:{delimiter:"comma",requireLast:!1}}],"@typescript-eslint/no-confusing-non-null-assertion":"warn","@typescript-eslint/no-explicit-any":"off","@typescript-eslint/no-non-null-assertion":"off","@typescript-eslint/no-unnecessary-condition":"off","@typescript-eslint/no-unused-expressions":"error","@typescript-eslint/no-var-requires":"off","@typescript-eslint/prefer-includes":"off","@typescript-eslint/prefer-readonly":"off","@typescript-eslint/semi":"error","@typescript-eslint/switch-exhaustiveness-check":"off","@typescript-eslint/triple-slash-reference":"off"}:{"array-callback-return":"warn","class-methods-use-this":"error","comma-dangle":"off","eol-last":"error","jsx-quotes":["error","prefer-single"],"no-constant-condition":"off","no-multiple-empty-lines":"error","no-extra-parens":"off","no-lone-blocks":"warn","no-sequences":"error","no-template-curly-in-string":"warn","no-trailing-spaces":"error","no-unused-expressions":"off","prefer-named-capture-group":"off","require-await":"error",semi:"off","react/display-name":"off","react/jsx-handler-names":"off","react/jsx-no-comment-textnodes":"error","react/jsx-tag-spacing":"warn","react/no-children-prop":"off","react/prop-types":"off","react/self-closing-comp":"error","jsx-a11y/click-events-have-key-events":"off","jsx-a11y/interactive-supports-focus":"off","@typescript-eslint/comma-dangle":["warn","always-multiline"],"@typescript-eslint/consistent-type-imports":"off","@typescript-eslint/explicit-module-boundary-types":["warn",{allowArgumentsExplicitlyTypedAsAny:!0}],"@typescript-eslint/member-delimiter-style":["warn",{multiline:{delimiter:"comma",requireLast:!0},singleline:{delimiter:"comma",requireLast:!1}}],"@typescript-eslint/no-confusing-non-null-assertion":"warn","@typescript-eslint/no-explicit-any":"off","@typescript-eslint/no-non-null-assertion":"off","@typescript-eslint/no-unnecessary-condition":"off","@typescript-eslint/no-unused-expressions":"error","@typescript-eslint/no-var-requires":"off","@typescript-eslint/prefer-includes":"off","@typescript-eslint/prefer-readonly":"off","@typescript-eslint/semi":"error","@typescript-eslint/switch-exhaustiveness-check":"off","@typescript-eslint/triple-slash-reference":"off"}},cache:!0,cacheLocation:`.cache/eslint-${e}`}),i=await o.lintFiles(s),a=(await o.loadFormatter("stylish")).format(i);a?console.log(a):(0,n.logInfo)("esl","clear")}},"tools/typescript":(e,t)=>{const r=require("path"),n=require("typescript"),s=require("chalk"),o=t("common"),i=t("config");e.MyJSXRuntime="function myjsx(type,rawprops,maybekey){const props={};for(const n in rawprops){if(!['key','ref','__self','__source'].includes(n)){props[n]=rawprops[n]}}return{$$typeof:Symbol.for('react.element'),type,key:rawprops.key!==void 0?''+rawprops.key:maybekey!==void 0?''+maybekey:null,ref:rawprops.ref!==void 0?rawprops.ref:null,props,_owner:React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner.current}}function myjsxf(p,k){return myjsx(Symbol.for('react.fragment'),p,k)}";const a={lib:["lib.esnext.d.ts"],target:n.ScriptTarget.ESNext,module:n.ModuleKind.CommonJS,moduleResolution:n.ModuleResolutionKind.NodeJs,skipLibCheck:!0,noEmitOnError:!0,strict:"AKARIN_TS_STRICT"in process.env,noImplicitAny:!0,noFallthroughCaseInSwitch:!0,noImplicitReturns:!0,noImplicitThis:!0,noUnusedLocals:!0,noUnusedParameters:!0,strictNullChecks:"AKARIN_TS_STRICT"in process.env,strictFunctionTypes:!0,strictBindCallApply:!0,removeComments:!0};function c({category:e,code:t,messageText:r,file:i,start:a},c){if(6031!=t)if(6032==t)(0,o.logInfo)(`tsc${c}`,"recheck");else{if(6194==t)return;{const o=(0,{[n.DiagnosticCategory.Warning]:s.red,[n.DiagnosticCategory.Error]:s.red,[n.DiagnosticCategory.Suggestion]:s.green,[n.DiagnosticCategory.Message]:s.cyan}[e])(`  TS${t} `);let c="";if(i&&a){const{line:e,character:t}=n.getLineAndCharacterOfPosition(i,a);c=s`{yellow ${i.fileName}:${e+1}:${t+1}} `}let l=n.flattenDiagnosticMessageText(r,"\n");l.includes("\n")&&(l="\n"+l),console.log(o+c+l)}}}function l(){const e=n.sys.readFile;n.sys.readFile=(t,r)=>{let n=e(t,r);return n&&!t.endsWith(".d.ts")&&(n=n.replaceAll("domain.com",i.config.domain),n=n.replaceAll("webroot",i.config.webroot),i.config.apps&&(n=n.replaceAll("APPSETTING",JSON.stringify(i.config.apps.map((e=>({name:e.name,origin:e.origin,socket:e.socket}))))))),n}}function p(e,t){return(r,n)=>{if(r.endsWith(".js")){n.startsWith('"use strict"')&&(n=n.slice(n.indexOf("\n")+1)),n.startsWith("Object.defineProperty")&&(n=n.slice(n.indexOf("\n")+1)),n.startsWith("exports.")&&(n=n.slice(n.indexOf("\n")+1));const t=/\/\/#\s*sourceMappingURL/.exec(n);if(t&&0==n.substring(0,t.index).trim().length)return;t&&"hide"==e.sourceMap?n=n.slice(0,t.index):n.endsWith("\n")||(n+="\n")}const s=t.findIndex((e=>e.name==r));s>=0?t.splice(s,1,{name:r,content:n}):t.push({name:r,content:n})}}class u{options;additionalHeader;compilerOptions;constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??"",this.compilerOptions=function(e){return"normal"==e.base?{...a,outDir:"/vbuild",sourceMap:"no"!=e.sourceMap,lib:"additionalLib"in e?[...a.lib,...e.additionalLib.map((e=>`lib.${e}.d.ts`))]:a.lib}:"jsx-page"==e.base?{...a,outDir:"/vbuild",target:n.ScriptTarget.ES2018,sourceMap:!1,esModuleInterop:!0,module:n.ModuleKind.ESNext,jsx:n.JsxEmit.ReactJSX,lib:[...a.lib,"lib.dom.d.ts"]}:{...a,outDir:r.resolve("src"),target:n.ScriptTarget.ES2018,sourceMap:!0,esModuleInterop:!0,module:n.ModuleKind.ESNext,jsx:n.JsxEmit.ReactJSX,lib:[...a.lib,"lib.dom.d.ts"]}}(e)}check(){(0,o.logInfo)("tsc",s`once {yellow ${this.options.entry}}`),("normal"!=this.options.base||void 0===this.options.configSubstitution||this.options.configSubstitution)&&l();const e=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry],t=[],r=function(e){const t=e.diagnostics.filter((e=>e.category==n.DiagnosticCategory.Error||n.DiagnosticCategory.Warning)).length,r=e.diagnostics.length-t;let i;i=0==r&&0==t?"no diagnostic":0!=r&&0==t?s`{yellow ${r}} infos`:0==r?s`{yellow ${t}} errors`:s`{yellow ${t}} errors and {yellow ${r}} infos`,(e.emitSkipped?o.logError:o.logInfo)("tsc",`completed with ${i}`);for(const t of e.diagnostics)c(t);return!e.emitSkipped}(n.createProgram(e,this.compilerOptions,n.createCompilerHost(this.compilerOptions)).emit(void 0,p(this.options,t)));return{success:r,files:t}}watch(e){(0,o.logInfo)(`tsc${this.additionalHeader}`,s`watch {yellow ${this.options.entry}}`),("normal"!=this.options.base||void 0===this.options.configSubstitution||this.options.configSubstitution)&&l();const t=[],r=Array.isArray(this.options.entry)?this.options.entry:[this.options.entry];setImmediate((()=>{n.createWatchProgram(n.createWatchCompilerHost(r,this.compilerOptions,n.sys,((...r)=>{const s=n.createEmitAndSemanticDiagnosticsBuilderProgram(...r),o=s.emit;return s.emit=(r,n,...s)=>{const i=o(r,p(this.options,t),...s);return i.emitSkipped||e({files:t}),i},s}),(e=>c(e,this.additionalHeader)),(e=>c(e,this.additionalHeader))))}))}}e.typescript=function(e,t){return new u(e,t)}},"tools/mypack":(e,t)=>{const r=require("path"),n=require("chalk"),s=require("crypto-js"),o=require("filesize"),i=require("source-map"),a=require("terser"),c=t("common");function l(e){const t=/\n/g,r=[];for(;;){const n=t.exec(e);if(!n)break;r.push(n.index)}return function(e){const t=r.findIndex((t=>t>e));return t<0?`${r.length+1}:${e-(r.length?r[r.length-1]:0)+1}`:0==t?`1:${e}`:`${t+1}:${e-r[t-1]+1}`}}class p{options;lastHash=null;lastModules=null;logHeader;constructor(e,t){this.options=e,this.logHeader=t?`mpk${t}`:"mpk"}updateFiles(e){this.options.files=e}getSources(){return this.options.files.filter((e=>e.name.endsWith(".js"))).map((({name:e,content:t})=>({filename:e,jsContent:t,mapContent:this.options.files.find((t=>t.name==e+".map"))?.content,mapIndex:l(t)})))}processModule(e,t){let n=r.relative(r.dirname(this.options.entry),e.filename);n.endsWith(".js")&&(n=n.slice(0,-3)),n.endsWith("index")&&(n=n.slice(0,-5)),0==n.length&&(n=".");const o=[],i=/require\("(?<request>\.[.\w\-/]*)"\);/g;for(;;){const n=i.exec(e.jsContent);if(!n)break;const s=n.groups.request,a=r.resolve(r.dirname(e.filename),s),l=t.some((e=>e.filename==a))?a:t.some((e=>e.filename==a+".js"))?a+".js":t.some((e=>e.filename==a+"/index.js"))?a+"/index.js":null;if(!l)return(0,c.logError)(this.logHeader,`${e.filename}: invalid module name ${s} at ${e.mapIndex(n.index)}`),null;let p=r.relative(r.dirname(this.options.entry),l);p=p.slice(0,-3),p.endsWith("index")&&(p=p.slice(0,-5)),0==p.length&&(p="."),o.push({index:n.index,raw:s,resolvedFileName:l,resolvedModuleName:p})}let a=0,l="";for(const{index:t,raw:r,resolvedModuleName:n}of o)l+=e.jsContent.slice(a,t),l+=`myimport("${n}");`,a=t+r.length+12;if(l+=e.jsContent.slice(a),this.options.externals)for(const[e,t]of Object.entries(this.options.externals))l=l.replaceAll(`require("${e}")`,t);return{name:n,source:e,requests:o,content:l,hash:(0,s.SHA256)(l).toString()}}checkCircularReference(e){const t=[{moduleName:e[0].name,parentFileName:"",parentRequirePosition:"",parentRequireRaw:""}],r=s=>{for(const o of s.requests){const i=e.find((e=>e.name==o.resolvedModuleName));if(t.some((e=>e.moduleName==i.name))){(0,c.logError)(this.logHeader,"circular reference encountered");for(const e of t.slice(1))console.log(n`   {${e.parentFileName==i.source.filename?"yellow":"white"} ${e.parentFileName}}`+n`:${e.parentRequirePosition}:{gray require("}${e.parentRequireRaw}{gray ")}`);throw console.log(n`   ${s.source.filename}:${s.source.mapIndex(o.index)}:{gray require("}{yellow ${o.raw}}{gray ")}`),new Error("circular reference")}t.push({parentFileName:s.source.filename,parentRequirePosition:s.source.mapIndex(o.index),parentRequireRaw:o.raw,moduleName:i.name}),r(i),t.pop()}};try{return r(e[0]),!1}catch(e){if("circular reference"==e.message)return!0;throw e}}emitRuntimePrefix(e,t){this.options.shebang&&(e.sb+="#!/usr/bin/env node\n",e.lineOffset+=1),e.sb+="app"==this.options.type?`((modules) => { const mycache = {};\n(function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`:`module.exports = ((modules) => { const mycache = {};\nreturn (function myrequire(modulename) { if (!(modulename in mycache)) { mycache[modulename] = {}; modules[modulename](mycache[modulename], myrequire); } return mycache[modulename]; })('${t}'); })({\n`,e.lineOffset+=2}async emitModule(e,t){if(e.sb+=`'${t.name}': (exports, myimport) => {\n${t.content}}, `,e.lineOffset+=1,e.generator&&!t.source.mapContent){let n=null;(await new i.SourceMapConsumer(JSON.parse(t.source.mapContent))).eachMapping((t=>{null===n&&(n=t.generatedLine),e.generator.addMapping({source:r.resolve(t.source),original:{line:t.originalLine,column:t.originalColumn},generated:{line:t.generatedLine-n+e.lineOffset+1,column:t.generatedColumn}})})),e.lineOffset+=t.content.split("\n").length-1}}emitRuntimePostfix(e){e.sb+="})\n"}printResult(e,t){if((0,c.logInfo)(this.logHeader,n`completed with {yellow 1} asset {yellow ${o(e)}}`),this.options.printModules){const e=this.lastModules;if(e){for(const r of t.filter((t=>!e.some((e=>e.source==t.source.filename)))))console.log(n`  {gray +} ${r.name} ({gray ${r.source.filename}}) ${o(r.content.length)}`);for(const[r]of t.map((t=>[t,e.find((e=>e.source==t.source.filename))])).filter((([e,t])=>t&&e.hash!=t.hash)))console.log(n`  {gray *} ${r.name} ({gray ${r.source.filename}}) ${o(r.content.length)}`);for(const r of e.filter((e=>!t.some((t=>t.source.filename==e.source)))))console.log(n`  {gray - removed} ${r.name} ({gray ${r.source}})`)}else for(const{name:e,source:r,content:s}of t){const t=r.filename.startsWith("/vbuild/")?r.filename.slice(8):r.filename;console.log(n`   {gray +} ({gray ${t}}) {greenBright ${e}} ${o(s.length)}`)}}}async run(){const e=this.options.entry;(0,c.logInfo)(this.logHeader,this.lastHash?"repack":n`pack {yellow ${e.startsWith("/vbuild/")?e.slice(8):e}}`);const t=this.getSources();if(!t.some((t=>t.filename==e)))return(0,c.logError)(this.logHeader,"invalid entry"),{success:!1};const r=[],o=[e];for(let e=0;e<o.length;++e){const n=this.processModule(t.find((t=>t.filename==o[e])),t);if(!n)return{success:!1};o.push(...n.requests.map((e=>e.resolvedFileName)).filter((e=>!o.includes(e)))),r.push(n)}if(this.checkCircularReference(r))return{success:!1};const l={sb:"",lineOffset:0,generator:this.options.sourceMap?new i.SourceMapGenerator({file:this.options.output}):null};this.emitRuntimePrefix(l,r[0].name);for(const e of r)await this.emitModule(l,e);this.emitRuntimePostfix(l);let p=l.sb,u=l.generator?.toString();if(this.options.minify){const e=await(0,a.minify)(p,{sourceMap:!!this.options.sourceMap&&{content:u,filename:this.options.output,url:this.options.output+".map"},format:{max_line_len:"AKARIN_SELF_MULTILINE"in process.env?120:void 0}});p=e.code,u="object"==typeof e.map?JSON.stringify(e.map):e.map}const m=(0,s.SHA256)(p).toString(),d=m!=this.lastHash;return d?this.printResult(p.length,r):(0,c.logInfo)(this.logHeader,n`completed with {gray no change}`),"cleanupFiles"in this.options&&!this.options.cleanupFiles||function(e,t){const r=t.filter((t=>!e.some((e=>e.source.filename==t.name))&&!e.some((e=>e.source.filename+".map"==t.name))));for(const e of r)t.splice(t.indexOf(e),1),e.name.endsWith(".map")||console.log(n`   {gray - ${e.name}}`)}(r,this.options.files),this.lastHash=m,this.lastModules=r.map((e=>({name:e.name,source:e.source.filename,hash:e.hash}))),{success:!0,hasChange:d,resultJs:Buffer.from(p),resultMap:u?Buffer.from(u):void 0}}}e.mypack=function(e,t){return new p(e,t)}},"tools/codegen":(e,t)=>{const r=require("fs/promises"),n=require("fs"),s=require("chalk"),o=require("xml2json"),i=t("config"),a=t("common"),c="src/api/api.xml",l=["GET","POST","PUT","PATCH","DELETE"],p={GET:"get",POST:"post",PUT:"put",PATCH:"patch",DELETE:"del"},u=["id","number","string","boolean","date","time"],m={id:{pattern:"\\d+",validator:"validateId",tsType:"number"},number:{pattern:"\\d+",validator:"validateNumber",tsType:"number"},string:{pattern:".+",validator:null,tsType:"string"},boolean:{pattern:"(true|false)",validator:"validateBoolean",tsType:"boolean"},date:{pattern:"\\d{6}",validator:"validateDate",tsType:"Dayjs"},time:{pattern:"\\d{12}",validator:"validateTime",tsType:"Dayjs"}},d="//-----------------------------------------------------------------------------------------------\n// This code was generated by a tool.\n// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.\n//-----------------------------------------------------------------------------------------------\n\n";async function f(){const e=await r.readFile(c,"utf-8"),{version:t,api:n}=(0,o.toJson)(e,{object:!0})[`${i.config.appname}-api`];return{version:t,definitions:n.map(((e,t)=>{const r=e.name;if(!r)throw new Error(`index ${t} api name is required`);const n=e.method;if(!l.includes(n))throw new Error(`api ${r} invalid method`);const s=e.path;if(!s)throw new Error(`api ${r} path is required`);if(!s.startsWith("/"))throw new Error(`api ${r} path should be absolute`);const o=function(e,t){const r=[];for(;;){const n=/\{(?<parameterName>[\w_]+):(?<parameterType>\w+)\}/.exec(t);if(!n)break;if(10==r.filter((e=>"parameter"==e.type)).length)throw new Error(`api ${e} too many parameters`);const[s,o]=[n.groups.parameterName,n.groups.parameterType];if(!u.includes(o))throw new Error(`api ${e} parameter ${s} invalid type ${o}`);0!=n.index&&r.push({type:"normal",value:t.slice(0,n.index)}),r.push({type:"parameter",parameterName:s,parameterType:o}),t=t.slice(n.index+s.length+o.length+3)}return t.length&&r.push({type:"normal",value:t}),r}(r,s),[i,a]=[e["body-type"],e["body-name"]];if(["POST","PUT","PATCH"].includes(n)&&(!i||!a))throw new Error(`api ${r} body is required for ${n}`);return{namespace:e.namespace||"default",apiName:r,method:n,apiPath:o,bodyType:i,bodyName:a,returnType:e["return-type"]||"void"}}))}}class h{target;additionalHeader;constructor(e,t){this.target=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??""}generate(){return"server"==this.target?async function(e){let t;await r.mkdir("src/api/server",{recursive:!0}),(0,a.logInfo)(`fcg${e}`,s`generate {yellow api/server}`);try{t=await f()}catch(t){return(0,a.logError)(`fcg${e}`,t.message),{success:!1}}const{version:n,definitions:o}=t,i=[],c=o.map((e=>e.namespace)).filter(((e,t,r)=>r.indexOf(e)==t)).map((e=>{return[e,(t=e,t.split("_").map((e=>e.charAt(0).toUpperCase()+e.substring(1))).join(""))];var t}));return i.push(...c.map((async([e,t])=>{const s=o.filter((t=>t.namespace==e));let i=d;i+="import { FineError } from '../../adk/error';\n",i+="import { ForwardContext, Context } from '../../adk/api-server';\n",i+=`import { ${u.filter((e=>s.some((t=>t.apiPath.some((t=>"parameter"==t.type&&t.parameterType==e)))))).map((e=>m[e].validator)).filter((e=>e)).concat(s.some((e=>["PUT","POST","PATCH"].includes(e.method)))?["validateBody"]:[]).join(", ")} } from '../../adk/api-server';\n`;const a=s.filter((e=>e.bodyType)).map((e=>e.bodyType)),c=s.filter((e=>"void"!=e.returnType)).map((e=>e.returnType.endsWith("[]")?e.returnType.slice(0,-2):e.returnType));i+=`import type { ${a.concat(c).filter(((e,t,r)=>r.indexOf(e)==t)).filter((e=>!["number"].includes(e))).join(", ")} } from '../types';\n`,i+="\n",i+=`export interface ${t}Impl {\n`;for(const{apiName:e,apiPath:t,bodyType:r,bodyName:n,returnType:o}of s){i+=`    ${e}: (`;for(const{parameterName:e,parameterType:r}of t.filter((e=>"parameter"==e.type)))i+=`${e}: ${m[r].tsType}, `;r&&(i+=`${n}: ${r}, `),i+="ctx: Context",i+=`) => Promise<${o}>,\n`}i+="}\n",i+="\n",i+=`export async function dispatch(ctx: ForwardContext, impl: ${t}Impl): Promise<void> {\n`,i+="    let match: RegExpExecArray;\n",i+=`    const methodPath = \`\${ctx.method} \${ctx.path.slice(${n.length+e.length+3})}\`;\n`,i+="\n";for(const{apiName:e,method:t,apiPath:r,bodyType:n,returnType:o}of s){i+=`    match = /^${t} `;for(const e of r)"normal"==e.type?i+=e.value.replaceAll("/","\\/"):i+=`(?<${e.parameterName}>${m[e.parameterType].pattern})`;i+="$/.exec(methodPath); if (match) {\n",i+="        ","void"!=o&&(i+="ctx.body = "),i+=`await impl.${e}(`;for(const{parameterName:e,parameterType:t}of r.filter((e=>"parameter"==e.type))){const r=m[t].validator;i+=r?`${r}('${e}', match.groups['${e}']), `:`match.groups['${e}'], `}n&&(i+="validateBody(ctx.body), "),i+="ctx.state",i+=");\n",n&&"void"==o&&(i+="        delete ctx.body;\n"),"POST"==t?i+="        ctx.status = 201;\n":"DELETE"==t&&(i+="        ctx.status = 204;\n"),i+="        return;\n",i+="    }\n"}i+="\n",i+="    throw new FineError('not-found', 'invalid invocation');\n",i+="}\n",await r.writeFile(`src/api/server/${e}.ts`,i)}))),i.push((async()=>{let e=d;e+="import { FineError } from '../../adk/error';\n",e+="import { ForwardContext } from '../../adk/api-server';\n";for(const[t,r]of c)e+=`import { ${r}Impl, dispatch as dispatch${r} } from './${t}';\n`;e+="\n",e+="export interface Impl {\n";for(const[t,r]of c)e+=`    ${t}: ${r}Impl,\n`;e+="}\n",e+="\n",e+="export async function dispatch(ctx: ForwardContext, impl: Impl) {\n",e+=`    if (!ctx.path.startsWith('/v${n}')) { throw new FineError('not-found', 'invalid invocation version'); }\n`,e+=`    const path = ctx.path.substring(${n.length+2});\n`;for(const[t,r]of c)e+=`    if (path.startsWith('/${t}/')) { return await dispatch${r}(ctx, impl.${t}); }\n`;e+="    throw new FineError('not-found', 'invalid invocation');\n",e+="}\n",await r.writeFile("src/api/server/index.ts",e)})()),await Promise.all(i),(0,a.logInfo)(`fcg${e}`,s`generate {yellow api/server} completed with ${i.length} files`),{success:!0}}(this.additionalHeader):async function(e){let t;await r.mkdir("src/api",{recursive:!0}),(0,a.logInfo)(`fcg${e}`,s`generate {yellow src/api/client}`);try{t=await f()}catch(t){return(0,a.logError)(`fcg${e}`,t.message),{success:!1}}const{version:n,definitions:o}=t;let c=d;o.some((e=>e.apiPath.some((e=>"parameter"==e.type&&["date","time"].includes(e.parameterType)))))&&(c+="import type { Dayjs } from 'dayjs';\n"),c+=`import { ${l.filter((e=>o.some((t=>t.method==e)))).map((e=>p[e])).join(", ")} } from '../adk/api-client';\n`;const u=o.filter((e=>e.bodyType)).map((e=>e.bodyType)),h=o.filter((e=>"void"!=e.returnType)).map((e=>e.returnType.endsWith("[]")?e.returnType.slice(0,-2):e.returnType));c+=`import type { ${u.concat(h).filter(((e,t,r)=>r.indexOf(e)==t)).filter((e=>!["number"].includes(e))).join(", ")} } from './types';\n`,c+="\n";for(const e of o.map((e=>e.namespace)).filter(((e,t,r)=>r.indexOf(e)==t))){c+=`export const ${"default"==e?"$default":e} = {\n`;for(const{apiName:t,method:r,apiPath:s,bodyType:a,bodyName:l,returnType:u}of o.filter((t=>t.namespace==e))){c+=`    ${t}: (`;for(const{parameterName:e,parameterType:t}of s.filter((e=>"parameter"==e.type)))c.endsWith("(")||(c+=", "),c+=`${e}: ${m[t].tsType}`;a&&(c.endsWith("(")||(c+=", "),c+=`${l}: ${a}`),c+=`): Promise<${u}> => ${p[r]}(\`/${i.config.appname}/v${n}/${e}`;for(const e of s)"normal"==e.type?c+=e.value:"date"==e.parameterType?c+=`\${${e.parameterName}.format('YYYYMMDD')}`:"time"==e.parameterType?c+=`\${${e.parameterName}.format('YYYYMMDDHHmmdd')}`:c+=`\${${e.parameterName}}`;c+="`",a&&(c+=`, ${l}`),c+="),\n"}c+="};\n"}return await r.writeFile("src/api/client.ts",c),(0,a.logInfo)(`fcg${e}`,s`generate {yellow api/client} completed`),{success:!0}}(this.additionalHeader)}watch(){(0,a.logInfo)(`fcg${this.additionalHeader}`,s`watch {yellow ${c}}`);let e=!0;n.watch(c,{persistent:!1},(()=>{e=!0})),setInterval((()=>{e&&(e=!1,this.generate())}),3007)}}e.codegen=function(e,t){return new h(e,t)}},"tools/sass":(e,t)=>{const r=require("fs"),n=require("chalk"),s=require("sass"),o=t("common");class i{options;additionalHeader;constructor(e,t){this.options=e,this.additionalHeader=t,this.additionalHeader=this.additionalHeader??""}transpile=()=>new Promise((e=>{(0,o.logInfo)("css",n`once {yellow ${this.options.entry}}`);const t=process.hrtime.bigint();try{const r=(0,s.compile)(this.options.entry,{style:"compressed"}),n=process.hrtime.bigint();(0,o.logInfo)("css",`completed in ${(n-t)/1000000n}ms`),e({success:!0,resultCss:Buffer.from(r.css,"utf-8")})}catch(t){t instanceof s.Exception?(0,o.logError)("css",`error at ${t.span.url}:${t.span.start.line}:${t.span.start.column}: ${t.message}`):(0,o.logError)("css",`error ${t}`),e({success:!1})}}));watch(e){const t=this.options.entry,i=`css${this.additionalHeader}`;(0,o.logInfo)(i,n`watch {yellow ${t}}`);const a=[];let c="none",l=[t];!function n(){c="running";for(const e of a)e.close();a.splice(0,a.length);let p=[t];const u=process.hrtime.bigint();try{const r=(0,s.compile)(t,{style:"compressed",importers:[{findFileUrl:e=>(p.push(e),new URL(e))}]}),n=process.hrtime.bigint();(0,o.logInfo)(i,`completed in ${(u-n)/1000000n}ms`),e({success:!0,resultCss:Buffer.from(r.css)})}catch(e){e instanceof s.Exception?(0,o.logError)("css",`error at ${e.span.url}:${e.span.start.line}:${e.span.start.column}: ${e.message}`):(0,o.logError)("css",`error ${e}`),p=l}for(const e of p)a.push(r.watch(e,{persistent:!1},(()=>{"running"==c?((0,o.logInfo)(i,"retranspile waiting"),c="pending"):"none"==c&&((0,o.logInfo)(i,"retranspile (1)"),n())})));l=p,"pending"==c?((0,o.logInfo)(i,"retranspile (2)"),n()):"running"==c&&(c="none")}()}}e.sass=function(e,t){return new i(e,t)}}});